#!groovy

taskmap = [:];
utils = [:];

node {
    stage('get files') {
        checkout scm;
        echo "getting taskmap";
        taskmap = readJSON file : "folder/taskmap.json";
        assert taskmap.farm1.ip == "0.0.0";
        echo "done getting taskmap";
        echo "====================";
        echo "loading utils";
        utils = load "folder/pytest-utils.groovy";
        assert utils.echoDebug("hi") == "hi";
        echo "done loading utils"
    }
}

def test_tasks = [:]

taskmap.each { taskname, tasksettings -> 
    def setup = [:]
    setup.'name'    = taskname;
    setup.'ip'      = tasksettings.ip;
    setup.'configs' = tasksettings.pr_configs;
    setup.'tests'   = '';
    setup.'type'    = 'pr_configs';

    test_tasks[taskname] = utils.generateTestNode(setup);
}

parallel(test_tasks)

node {
    stage('test') {
        echo 'test pytest-utils on another node';
        assert utils.echoDebug("hi") == "hi";
        echo "done testing utils"
    }
}